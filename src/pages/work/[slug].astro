---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/astro/Header.astro";
import About from "../../components/astro/About.astro";
import Footer from "../../components/astro/Footer.astro";
import WorkGrid from "../../components/astro/WorkGrid.astro";
import { getEntryBySlug } from "astro:content";
import { getAllWorks } from "../../data/works";
import { profile } from "../../data/profile";

interface Props {
  params: { slug: string };
}

const { slug } = Astro.params;
const entry = await getEntryBySlug("works", slug || "");
const works = await getAllWorks();

if (!entry) {
  return Astro.redirect("/404");
}

const work = { ...entry.data, slug: entry.slug };
const projectTitle = work.projectTitle ?? work.title;
const workUrl = work.url;
const markdownBody = entry.body?.trim();
const { Content } = await entry.render();
const metaDescription = [
  work.company,
  String(work.year),
  work.detailDescription || work.description,
]
  .filter(Boolean)
  .join(" / ")
  .trim()
  .slice(0, 160);

// 静的生成のための全スラッグを取得
export async function getStaticPaths() {
  const works = await getAllWorks();
  return works.map((work) => ({
    params: { slug: work.slug },
  }));
}
---

<BaseLayout
  title={`${work.title} | Yuki Shimizu`}
  description={metaDescription}
>
  <Header />
  <main id="main" class="flex flex-col gap-section-gap">
    <article class="flex flex-col gap-section-gap py-section-gap">
      <header
        class="flex flex-col gap-div-gap w-[85vw] sm:w-[80vw] max-w-[1400px] mx-auto"
      >
        <div
          class="flex flex-row items-center gap-item-gap max-[800px]:flex-col max-[800px]:items-start"
        >
          <div class="flex flex-col items-start gap-item-gap">
            <div class="flex flex-col items-start gap-2">
              <h1
                class="text-4xl sm:text-5xl leading-relaxed sm:leading-relaxed"
              >
                {projectTitle}
              </h1>
              {
                workUrl && (
                  <a
                    href={workUrl}
                    target="_blank"
                    rel="noreferrer"
                    class="text-small opacity-50 break-all hover:opacity-100"
                  >
                    {workUrl}
                  </a>
                )
              }
            </div>
            <div
              class="flex flex-row flex-wrap items-center gap-thin-gap max-[800px]:items-center max-[800px]:flex-wrap"
            >
              <p>
                <b>{work.company}</b>
              </p>
              <div
                class="flex flex-row items-center gap-[calc(var(--thin-gap)/2)]"
              >
                <img src="/img/icon/calendar.svg" alt="Year" class="block" />
                <p>{work.year}</p>
              </div>
              {
                work.tags && work.tags.length > 0 && (
                  <div class="flex flex-row items-center gap-[calc(var(--thin-gap)/2)]">
                    <img src="/img/icon/tag.svg" alt="Tag" class="block" />
                    <p>{work.tags.join(", ")}</p>
                  </div>
                )
              }
            </div>
            <p class="opacity-50 leading-8">
              {work.detailDescription || work.description}
            </p>
          </div>
          <div class="w-[80%] h-full flex-1 max-[800px]:hidden"></div>
        </div>
      </header>

      <section
        aria-label="Work detail"
        class="flex flex-col gap-div-gap w-[85vw] sm:w-[80vw] max-w-[1400px] mx-auto"
      >
        <h2 class="sr-only">Work detail</h2>
        <div
          class="flex flex-col items-start gap-item-gap max-[800px]:flex-col min-w-0"
        >
          {
            work.content.map((item, index) => {
              if (item.type === "image") {
                return (
                  <img
                    src={item.src}
                    alt={item.alt || `${work.title} - Image ${index + 1}`}
                    class="block max-w-full h-auto"
                    data-reveal
                    style="--reveal-delay: 0ms;"
                  />
                );
              }

              if (item.type === "list") {
                const listClass =
                  item.style === "ordered"
                    ? "list-decimal pl-6"
                    : "list-disc pl-6";

                return (
                  <div
                    class="w-full min-w-0 max-w-full"
                    data-reveal
                    style="--reveal-delay: 0ms;"
                  >
                    {item.style === "ordered" ? (
                      <ol class={`text-p leading-8 break-words ${listClass}`}>
                        {item.items.map((text) => (
                          <li>{text}</li>
                        ))}
                      </ol>
                    ) : (
                      <ul class={`text-p leading-8 break-words ${listClass}`}>
                        {item.items.map((text) => (
                          <li>{text}</li>
                        ))}
                      </ul>
                    )}
                  </div>
                );
              }

              return (
                <div
                  class="w-full min-w-0 max-w-full"
                  data-reveal
                  style="--reveal-delay: 0ms;"
                >
                  <p class="text-p leading-8 whitespace-pre-line break-words">
                    {item.content}
                  </p>
                </div>
              );
            })
          }
        </div>
        {
          markdownBody && (
            <div
              class="work-markdown w-full min-w-0 max-w-full"
              data-markdown-reveal-start={work.content.length}
            >
              <Content />
            </div>
          )
        }
      </section>
    </article>
    <div class="w-[90vw] sm:w-[90vw] max-w-[1400px] mx-auto">
      <hr class="border-0 border-t border-line" />
    </div>
    <WorkGrid works={works} />
    <About profile={profile} />
  </main>
  <Footer profile={profile} />
</BaseLayout>
